#' Main worker function for setting up an analysis pipeline
#'
#' @param analysis_name A character string providing a useful name for identifying this analysis. Practically, this
#'   influences the top-level folder name of the group analysis outputs, as well as the name of .RData objects
#'   saved by this function to the working directory for the analysis.
#' @param scheduler Which HPC scheduler system should be used for queueing jobs. Options are 'slurm' or 'torque'.
#' @param subject_data A data.frame containing all subject-level data such as age, sex, or other covariates. Columns
#'   from \code{subject_data} can be used as covariates in group (aka 'level 3') analyses.
#' @param trial_data A data.frame containing trial-level statistics for all subjects. Data should be stacked in long
#'   form such that each row represents a single trial for a given subject and the number of total rows is subjects x trials.
#' @param variable_mapping A named character vector containing key identifying columns in \code{subject_data} and
#'   \code{trial_data}. Minimally, this vector should contain the elements 'id' 
#' @param id_column A character string indicating the name of the subject identifier in \code{subject_data} and \code{trial_data}.
#' @param bad_ids An optional vector of ids in \code{subject_data} and \code{trial_data} that should be excluded from analysis.
#' @param mr_dir_column A character string indicating the column name in \code{subject_data} containing the folder for each
#'   subject's data. Default is "mr_dir".
#' @param fmri_file_regex A character string containing a Perl-compatible regular expression 
#' @param tr The repetition time of the scanning sequence in seconds. Used for setting up design matrices
#' @param working_directory The working directory for all configuration and job submission files for this analysis.
#'   Default is a subfolder called "glm_out" in the current working directory.
#' @param drop_volumes The number of volumes to drop from the fMRI data and convolved regressors prior to analysis.
#'   Default is 0.
#' @param l1_model_variants A list of model specifications for the level 1 (aka run-level) voxelwise GLM analyses.
#'   Each element is a vector of regressors to be included in the convolved regressors of a level 1 GLM design matrix.
#'   List elements can be named for internal cross-referencing with l1_contrasts so that specific models can be paired
#'   with contrasts that test combinations of the explanatory variables in the model.
#' @param l1_contrasts An optional list of contrasts to be included in level 1 (aka run-level) voxelwise GLM analyses.
#'   Elements should be named, and names should match a single model in \code{l1_model_variants} so that models and
#'   contrasts can be combined properly to form contrasts of parameter estimates (COPEs in FSL-speak).
#' @param l1_include_diagonal_contrasts A boolean indicating whether a contrast representing each regressor alone
#'   should be added to the l1 contrast matrix for each model. This is a good idea in general so that FSL generates
#'   a COPE for each explanatory variable (EV) in the model, which allows you to examine simple group maps. If this is
#'   set to \code{FALSE}, then you will be on the hook to provide all contrasts for each model in \code{l1_contrasts}.
#' @param use_preconvolve A boolean indicating whether to enter convolved regressors into the GLM estimation software
#'   (e.g., FSL FILM/FEAT). If \code{TRUE}, all regressors will be generated by build_design_matrix in the dependlab
#'   R package. If \code{FALSE}, onset-duration-value timing will be entered and convolution will be handled internally
#'   by the GLM software. I recommend \code{TRUE} for consistency.
#'
#' @param additional A list of additional metadata that will be added to the \code{glm.pipeline} object returned
#'   by the function. This can be useful if there are other identifiers that you want for long-term storage or
#'   off-shoot functions.
#'
#' @importFrom checkmate assert_subset assert_data_frame assert_number assert_integerish assert_list assert_logical
setup_glm_pipeline <- function(analysis_name="glm_analysis", scheduler="slurm", subject_data=NULL, trial_data=NULL,
                               variable_mapping=c(id="id", run="run", trial="trial", run_trial="tria", mr_dir="mr_dir"),
                               bad_ids=NULL,
                               fmri_file_regex=".*\\.nii\\.gz", tr=NULL, working_directory=file.path(getwd(), "glm_out"),
                               drop_volumes=0L, l1_model_variants=NULL, l1_contrasts=NULL, l1_include_diagonal_contrasts=TRUE,
                               
                               use_preconvolve=TRUE, 
                               additional=list()) {
  checkmate::assert_subset(scheduler, c("slurm", "sbatch", "torque", "qsub"), empty.ok=FALSE)
  checkmate::assert_data_frame(subject_data)
  checkmate::assert_data_frame(trial_data)
  checkmate::assert_number(tr)
  checkmate::assert_integerish(drop_volumes)
  checkmate::assert_list(l1_model_variants)
  checkmate::assert_list(l1_contrasts, null.ok=TRUE)
  checkmate::assert_logical(l1_include_diagonal_contrasts)

  #setup working directory, if needed
  if (!dir.exists(working_directory)) {
    message("Setting up working directory for pipeline: ", working_directory)
    dir.create(working_directory, recursive=TRUE)
  }

  

  
}
